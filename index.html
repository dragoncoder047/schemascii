<!doctype html>
<html>

    <head>
        <title>Schemascii</title>
        <script src="https://cdn.jsdelivr.net/pyodide/v0.23.2/full/pyodide.js"></script>
        <style>
            .flex {
                display: flex;
                flex: 1;
                padding: 2px;
            }

            .flex.row {
                flex-direction: row;
            }

            .flex.column {
                flex-direction: column;
            }

            textarea {
                min-height: 10ch;
            }

            #errors {
                color: red;
            }

            @media screen and (prefers-color-scheme: dark) {
                body {
                    color: white;
                    background: black;
                }
            }
        </style>
        <style id="custom-css"></style>
    </head>

    <body>
        <h1>Schemascii Playground</h1>
        <div class="flex row">
            <div class="flex column">
                <p>Schemascii Source</p><textarea id="schemascii"></textarea>
            </div>
            <div class="flex column">
                <p>CSS</p><textarea id="css"></textarea>
            </div>
        </div>
        <div id="output"></div>
        <pre id="console"></pre>
        <pre id="errors"></pre>
    </body>
    <script>
        // cSpell:ignore pyodide pyproject pyimport
        var pyodide;
        var output = document.getElementById("output");
        var css = document.getElementById("css");
        var console = document.getElementById("console");
        var source = document.getElementById("schemascii");
        var style_elem = document.getElementById("custom-css");
        var render_button = document.getElementById("render");
        var schemascii;
        async function main() {
            try {
                info("Loading Python... ");
                pyodide = await loadPyodide({ stdout: info, stderr: error });
                info("done\nInstalling micropip...");
                await pyodide.loadPackage("micropip", { errorCallback: error, messageCallback: info });
                info("done\nFetching current Schemascii version... ");
                var pyproject_toml = await fetch("pyproject.toml").then(x => x.text());
                var ver = /version = "([\d.]+)"/.exec(pyproject_toml)[1];
                info(`${ver}\nInstalling schemascii-${ver} ... `);
                await pyodide.pyimport("micropip", { errorCallback: error, messageCallback: info })
                    .install(`https://dragoncoder047.github.io/schemascii/dist/schemascii-${ver}-py3-none-any.whl`);
                schemascii = pyodide.pyimport("schemascii");
                await setup();
                console.textContent = "ready\n";
            } catch (e) {
                error(`\nJS Error:\n${e.stack}\n`);
                throw e;
            }
        }
        function info(line) {
            console.textContent += line;
        }
        function error(text) {
            errors.textContent += text;
        }
        async function setup() {
            css.value = await fetch("schemascii_example.css").then(x => x.text());
            style_elem.innerHTML = css.value;
            css.addEventListener("input", () => {
                style_elem.innerHTML = css.value;
            });
            var timeout = null;
            source.addEventListener("input", () => {
                if (timeout) clearTimeout(timeout);
                setTimeout(async () => {
                    console.textContent = "";
                    errors.textContent = "";
                    try {
                        output.innerHTML = await schemascii.render("playground", source.value);
                    } catch (e) {
                        error(`\nJS Error:\n${e.stack}\n`);
                        output.innerHTML = "";
                        throw e;
                    }
                }, 500);
            });
        }
        main();
    </script>

</html>